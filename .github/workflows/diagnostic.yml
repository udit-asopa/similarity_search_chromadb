name: Diagnostic - CI Troubleshooting

on:
  workflow_dispatch:  # Manual trigger only
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'

jobs:
  diagnose:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“‹ Environment Information
      run: |
        echo "ğŸ–¥ï¸ System Information"
        echo "==================="
        uname -a
        echo ""
        echo "ğŸ Python Information"
        echo "==================="
        which python3
        python3 --version
        echo ""
        echo "ğŸ“¦ Package Managers"
        echo "=================="
        which pip || echo "pip not found"
        which conda || echo "conda not found"
        echo ""
        
    - name: ğŸ“‚ Project Structure Analysis
      run: |
        echo "ğŸ“‚ Project Root Contents"
        echo "======================="
        ls -la
        echo ""
        echo "ğŸ“„ Key Files Check"
        echo "=================="
        [ -f pixi.toml ] && echo "âœ… pixi.toml exists" || echo "âŒ pixi.toml missing"
        [ -f README.md ] && echo "âœ… README.md exists" || echo "âŒ README.md missing"
        [ -d api ] && echo "âœ… api/ directory exists" || echo "âŒ api/ directory missing"
        [ -d tests ] && echo "âœ… tests/ directory exists" || echo "âŒ tests/ directory missing"
        [ -d .github/workflows ] && echo "âœ… workflows/ directory exists" || echo "âŒ workflows/ directory missing"
        echo ""
        echo "ğŸ“‹ Workflow Files"
        echo "================"
        ls -la .github/workflows/ || echo "No workflows directory"
    
    - name: ğŸ”§ Pixi Installation Test
      run: |
        echo "ğŸ“¦ Installing Pixi..."
        curl -fsSL https://pixi.sh/install.sh | bash
        export PATH="$HOME/.pixi/bin:$PATH"
        
        echo "ğŸ” Pixi Version Check"
        pixi --version || echo "âŒ Pixi installation failed"
        
        echo "ğŸ“‹ Pixi Project Info"
        if [ -f pixi.toml ]; then
          pixi info || echo "âš ï¸ Pixi info failed"
        else
          echo "âŒ pixi.toml not found - cannot run pixi commands"
        fi
    
    - name: ğŸ“¦ Direct Dependency Check
      run: |
        echo "ğŸ Direct Python Package Installation"
        echo "===================================="
        
        # Try installing key packages directly
        pip install --user pytest fastapi uvicorn pydantic || echo "âš ï¸ Some packages failed to install"
        
        echo ""
        echo "âœ… Installed packages:"
        pip list --user
        
        echo ""
        echo "ğŸ§ª Import Test"
        python3 -c "
        packages = ['pytest', 'fastapi', 'pydantic', 'uvicorn']
        for pkg in packages:
            try:
                __import__(pkg)
                print(f'âœ… {pkg}: Import successful')
            except ImportError as e:
                print(f'âŒ {pkg}: Import failed - {e}')
        "
    
    - name: ğŸ§ª Simple Test Execution
      run: |
        echo "ğŸ§ª Simple Test Execution"
        echo "======================="
        
        if [ -d tests ]; then
          echo "ğŸ“ Tests directory found"
          echo "Test files:"
          find tests -name "*.py" | head -5
          
          echo ""
          echo "ğŸ” Trying to run a simple test..."
          
          # Try to run the most basic test
          if [ -f tests/unit/test_basic.py ]; then
            echo "Running test_basic.py..."
            python3 -m pytest tests/unit/test_basic.py -v --tb=short || echo "âš ï¸ Basic test failed"
          elif [ -f tests/test_setup.py ]; then
            echo "Running test_setup.py..."
            python3 -m pytest tests/test_setup.py -v --tb=short || echo "âš ï¸ Setup test failed"
          else
            echo "ğŸ“‹ Available test files:"
            find tests -name "test_*.py" | head -3
          fi
        else
          echo "âŒ No tests directory found"
        fi
    
    - name: ğŸ” Error Analysis
      run: |
        echo "ğŸ” Common CI Issues Analysis"
        echo "============================"
        
        echo "1. ğŸ“¦ Dependency Issues:"
        echo "   - Check if all required packages are in pixi.toml"
        echo "   - Verify Python version compatibility"
        echo ""
        
        echo "2. ğŸ”§ Path Issues:"
        echo "   - PYTHONPATH configuration"
        echo "   - Module import paths"
        echo "   - Current working directory"
        pwd
        echo "   Python path:"
        python3 -c "import sys; print('\n'.join(sys.path))"
        echo ""
        
        echo "3. ğŸ¯ Environment Variables:"
        env | grep -E "(PYTHON|PATH|PIXI)" || echo "No relevant env vars found"
        echo ""
        
        echo "4. ğŸ“‹ Recommendations:"
        echo "   âœ… Start with basic-ci.yml workflow (most reliable)"
        echo "   âœ… Fix dependency issues before advanced testing"
        echo "   âœ… Use continue-on-error: true for unstable tests"
        echo "   âœ… Test locally with 'pixi run test-unit' first"
    
    - name: ğŸ“‹ Diagnostic Summary
      run: |
        echo ""
        echo "ğŸ¯ DIAGNOSTIC SUMMARY"
        echo "===================="
        echo ""
        echo "This workflow helps identify why CI is failing."
        echo ""
        echo "ğŸ“‹ Check the logs above for:"
        echo "   - âŒ Missing files or directories"
        echo "   - âŒ Package installation failures" 
        echo "   - âŒ Import errors"
        echo "   - âŒ Path configuration issues"
        echo ""
        echo "ğŸš€ Recommended next steps:"
        echo "   1. Fix any âŒ issues found above"
        echo "   2. Test changes locally first"
        echo "   3. Use basic-ci.yml for initial setup"
        echo "   4. Gradually enable advanced workflows"
        echo ""
        echo "âœ… Diagnostic workflow completed!"