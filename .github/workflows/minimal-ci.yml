name: Minimal CI - Structure Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  structure-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ“‚ Project Structure
      run: |
        echo "ğŸ  Repository Structure Check"
        echo "============================="
        echo ""
        echo "ğŸ“ Root contents:"
        ls -la
        echo ""
        echo "ğŸ“„ Key files:"
        [ -f README.md ] && echo "âœ… README.md" || echo "âŒ README.md missing"
        [ -f pixi.toml ] && echo "âœ… pixi.toml" || echo "âŒ pixi.toml missing" 
        [ -d api ] && echo "âœ… api/ directory" || echo "âŒ api/ directory missing"
        [ -d tests ] && echo "âœ… tests/ directory" || echo "âŒ tests/ directory missing"
        [ -d exercises ] && echo "âœ… exercises/ directory" || echo "âŒ exercises/ directory missing"
        echo ""
        
    - name: ğŸ Python Environment
      run: |
        echo "ğŸ Python Environment Check"
        echo "==========================="
        python3 --version
        pip --version
        echo "âœ… Python environment ready"
        
    - name: ğŸ“¦ Basic Dependencies
      run: |
        echo "ğŸ“¦ Installing minimal dependencies..."
        pip install pytest
        echo "âœ… Pytest installed: $(pytest --version)"
        
    - name: ğŸ” File Analysis
      run: |
        echo "ğŸ” Code Analysis"
        echo "==============="
        
        if [ -d api ]; then
          echo "ğŸ“ API files:"
          find api -name "*.py" 2>/dev/null | head -5 || echo "No Python files in api/"
        fi
        
        if [ -d tests ]; then
          echo "ğŸ“ Test files:"  
          find tests -name "*.py" 2>/dev/null | head -5 || echo "No test files found"
        fi
        
        echo ""
        echo "ğŸ“Š Python file count:"
        find . -name "*.py" 2>/dev/null | wc -l || echo "0"
        
    - name: âœ… Success Summary
      run: |
        echo ""
        echo "ğŸ‰ MINIMAL CI SUCCESS!"
        echo "====================="
        echo ""
        echo "âœ… Repository checked out successfully"
        echo "âœ… Project structure verified"
        echo "âœ… Python environment working"
        echo "âœ… Basic dependencies installed"
        echo ""
        echo "ğŸš€ This confirms the basic CI pipeline is working!"
        echo "ğŸ“‹ Next steps: Gradually add more complex tests"

  python-syntax-check:
    runs-on: ubuntu-latest
    needs: structure-check
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        
    - name: ğŸ” Python Syntax Check
      run: |
        echo "ğŸ” Checking Python syntax..."
        
        python_files=0
        syntax_errors=0
        
        # Check all Python files for syntax errors
        while IFS= read -r -d '' file; do
          python_files=$((python_files + 1))
          if python -m py_compile "$file"; then
            echo "âœ… $file"
          else
            echo "âŒ $file - SYNTAX ERROR"
            syntax_errors=$((syntax_errors + 1))
          fi
        done < <(find . -name "*.py" -not -path "./.git/*" -print0)
        
        echo ""
        echo "ğŸ“Š Syntax Check Summary:"
        echo "   Total Python files: $python_files"
        echo "   Syntax errors: $syntax_errors"
        
        if [ $syntax_errors -eq 0 ]; then
          echo "ğŸ‰ All Python files have valid syntax!"
        else
          echo "âŒ Found $syntax_errors files with syntax errors"
          exit 1
        fi

  import-check:
    runs-on: ubuntu-latest
    needs: python-syntax-check
    
    steps:
    - name: ğŸ”„ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python  
      uses: actions/setup-python@v5
      with:
        python-version: "3.13"
        
    - name: ğŸ“¦ Install Common Packages
      run: |
        pip install fastapi pydantic uvicorn httpx pytest
        
    - name: ğŸ” Import Test
      run: |
        echo "ğŸ” Testing Python imports..."
        
        export PYTHONPATH="${{ github.workspace }}:$PYTHONPATH"
        
        # Test if main modules can be imported
        echo "Testing core modules:"
        
        if [ -f api/main.py ]; then
          echo -n "  api.main: "
          if python -c "import api.main" 2>/dev/null; then
            echo "âœ…"
          else
            echo "âŒ (may need additional dependencies)"
          fi
        fi
        
        # Test individual Python files
        import_errors=0
        total_files=0
        
        echo ""
        echo "Testing individual files:"
        
        for file in $(find . -name "*.py" -not -path "./.git/*" | head -10); do
          total_files=$((total_files + 1))
          module=$(echo "$file" | sed 's|./||' | sed 's|/|.|g' | sed 's|.py$||')
          
          if [[ "$module" == *"__"* ]] || [[ "$module" == "setup" ]]; then
            continue  # Skip special files
          fi
          
          echo -n "  $module: "
          if timeout 10s python -c "import $module" 2>/dev/null; then
            echo "âœ…"
          else
            echo "âš ï¸"
            import_errors=$((import_errors + 1))
          fi
        done
        
        echo ""
        echo "ğŸ“Š Import Summary:"
        echo "   Files tested: $total_files"
        echo "   Import issues: $import_errors"
        echo ""
        echo "â„¹ï¸  Import issues are normal without all dependencies installed"